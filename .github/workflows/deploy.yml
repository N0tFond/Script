name: ğŸš€ Deploy Universal Linux Installer

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - "v*"
  pull_request:
    branches:
      - main

env:
  PROJECT_NAME: universal-linux-installer

jobs:
  # Tests et validation
  test:
    name: ğŸ§ª Test Scripts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distribution: [ubuntu-latest, ubuntu-20.04]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Make scripts executable
        run: |
          chmod +x install.sh
          chmod +x migrate.sh
          chmod +x test/*.sh
          chmod +x distributions/*/*.sh
          chmod +x security/security-audit.sh

      - name: ğŸ§ª Run detection tests
        run: |
          cd test
          ./test-detection.sh

      - name: ğŸ§ª Run non-interactive tests
        run: |
          cd test
          ./test-noninteractive.sh

      - name: ğŸ”’ Run security audit
        run: |
          cd security
          ./security-audit.sh

  # Analyse de sÃ©curitÃ©
  security:
    name: ğŸ” Security Analysis
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

  # Build et packaging
  build:
    name: ğŸ“¦ Build Release
    runs-on: ubuntu-latest
    needs: [test, security]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Create release archive
        run: |
          mkdir -p dist
          tar -czf dist/${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.VERSION }}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='dist' \
            --exclude='*.log' \
            .

      - name: ğŸ” Generate checksums
        run: |
          cd dist
          sha256sum *.tar.gz > checksums.txt

      - name: ğŸ“„ Generate release notes
        id: release_notes
        run: |
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸš€ Universal Linux Installer ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### âœ¨ Features:" >> $GITHUB_OUTPUT
          echo "- ğŸ” Automatic Linux distribution detection" >> $GITHUB_OUTPUT
          echo "- ğŸ“¦ Support for multiple distribution families" >> $GITHUB_OUTPUT
          echo "- ğŸ›¡ï¸ Security auditing and fixes" >> $GITHUB_OUTPUT
          echo "- ğŸ§ª Comprehensive testing suite" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ“‹ Supported Distributions:" >> $GITHUB_OUTPUT
          echo "- **Debian-based:** Ubuntu, Debian, Mint, Elementary, Pop!_OS, Kali" >> $GITHUB_OUTPUT
          echo "- **Arch-based:** Arch, Manjaro, EndeavourOS, ArcoLinux, Garuda" >> $GITHUB_OUTPUT
          echo "- **RedHat-based:** Fedora, CentOS, RHEL, Rocky, AlmaLinux" >> $GITHUB_OUTPUT
          echo "- **Other:** Gentoo, NixOS, Alpine, Void" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ“¥ Installation:" >> $GITHUB_OUTPUT
          echo "\`\`\`bash" >> $GITHUB_OUTPUT
          echo "curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/install.sh | bash" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: ğŸš€ Universal Linux Installer ${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            dist/*.tar.gz
            dist/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # DÃ©ploiement vers diffÃ©rents environnements
  deploy:
    name: ğŸŒ Deploy to Environments
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        environment: [staging, production]

    environment:
      name: ${{ matrix.environment }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup deployment environment
        run: |
          echo "Deploying to ${{ matrix.environment }} environment"
          # Ici vous pouvez ajouter vos Ã©tapes de dÃ©ploiement spÃ©cifiques

      - name: ğŸš€ Deploy scripts
        id: deploy
        run: |
          # Exemple de dÃ©ploiement vers un serveur
          # ssh user@server "mkdir -p /opt/universal-installer"
          # scp -r . user@server:/opt/universal-installer/
          echo "url=https://${{ matrix.environment }}.example.com" >> $GITHUB_OUTPUT
          echo "âœ… Deployed successfully to ${{ matrix.environment }}"

  # Notification
  notify:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¬ Send success notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          # Vous pouvez ajouter ici des notifications Slack, Discord, etc.

      - name: ğŸ“¬ Send failure notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          # Notification d'Ã©chec
