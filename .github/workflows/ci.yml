name: ğŸ§ª Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: ğŸ” Code Linting
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install shellcheck

      - name: ğŸ§¹ Lint shell scripts
        run: |
          find . -name "*.sh" -not -path "./.git/*" | xargs shellcheck -S warning

  test-distributions:
    name: ğŸ§ Test on Multiple Distributions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container:
          - ubuntu:22.04
          - ubuntu:20.04
          - debian:11
          - fedora:38
          - archlinux:latest

    container: ${{ matrix.container }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Install dependencies
        run: |
          if command -v apt-get > /dev/null; then
            apt-get update
            apt-get install -y curl wget sudo
          elif command -v dnf > /dev/null; then
            dnf install -y curl wget sudo
          elif command -v pacman > /dev/null; then
            pacman -Sy --noconfirm curl wget sudo
          fi

      - name: ğŸ§ª Test distribution detection
        run: |
          chmod +x install.sh
          chmod +x test/test-detection.sh
          ./test/test-detection.sh

      - name: ğŸ§ª Test non-interactive installation
        run: |
          chmod +x test/test-noninteractive.sh
          ./test/test-noninteractive.sh

  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Run Bandit security check
        run: |
          pip install bandit
          find . -name "*.py" | xargs bandit -r || true

      - name: ğŸ›¡ï¸ Run custom security audit
        run: |
          chmod +x security/security-audit.sh
          ./security/security-audit.sh
